name: Dart
on: pull_request

jobs:
  packages:
    strategy:
      matrix:
        package:
          - gql
          - gql_build
          - gql_code_builder
          - gql_exec
          - gql_link
          - gql_dedupe_link
          - gql_dio_link
          - gql_error_link
          - gql_http_link
          - gql_websocket_link
          - gql_link
          - gql_transform_link
          - cats
          - gql_example_http_auth_link
    runs-on: ubuntu-latest
    container:
      image: google/dart:latest
    name: Check ${{ matrix.package }}
    env:
      PACKAGE: ${{ matrix.package }}
    steps:
      - name: Clone repository
        uses: actions/checkout@v2
      - name: Activate tools
        run: |
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
          pub global activate melos
          pub global activate uni
      - name: Check pubspec
        run: |
          melos clean
          melos --scope $PACKAGE exec -- git diff --exit-code pubspec.yaml
      - name: Bootstrap
        run: |
          melos --scope $PACKAGE bootstrap
      - name: Get dependencies
        run: |
          melos --scope $PACKAGE exec -- uni pub get
      - name: Check formatting
        run: |
          echo ""
          echo "A list of incorrectly formatted files may follow:"
          echo ""
          melos --scope $PACKAGE exec -- uni --tooling legacy format -n . --set-exit-if-changed
          echo ""
      - name: Analyze package
        run: |
          melos --scope $PACKAGE exec -- uni analyze --version
          melos --scope $PACKAGE exec -- uni analyze --fatal-warnings .
      - name: Run tests
        run: |
          melos --scope $PACKAGE exec -- [ -d ./test ] || exit 0
          melos --scope $PACKAGE exec -- uni test
  examples:
    strategy:
      matrix:
        package:
          - gql_example_cli
          - gql_example_cli_github
          - gql_example_build
    runs-on: ubuntu-latest
    container:
      image: google/dart:latest
    name: Check ${{ matrix.package }}
    env:
      PACKAGE: ${{ matrix.package }}
    steps:
      - name: Clone repository
        uses: actions/checkout@v2
      - name: Activate tools
        run: |
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
          pub global activate melos
          pub global activate uni
      - name: Check pubspec
        run: |
          melos clean
          melos --scope $PACKAGE exec -- git diff --exit-code pubspec.yaml
      - name: Bootstrap
        run: |
          melos --scope $PACKAGE bootstrap
      - name: Get dependencies
        run: |
          melos --scope $PACKAGE exec -- uni pub get
      - name: Run builders
        run: |
          melos --scope $PACKAGE pub run build_runner build --delete-conflicting-outputs
      - name: Check build diff
        run: |
          melos --scope $PACKAGE exec git diff --exit-code **/*.gql.dart
      - name: Check formatting
        run: |
          echo ""
          echo "A list of incorrectly formatted files may follow:"
          echo ""
          melos --scope $PACKAGE uni --tooling legacy format -n . --set-exit-if-changed
          echo ""
      - name: Analyze package
        run: |
          melos --scope $PACKAGE exec -- uni analyze --version
          melos --scope $PACKAGE exec -- uni analyze --fatal-warnings .
  builder_tests:
    strategy:
      matrix:
        package:
          - end_to_end_test
    runs-on: ubuntu-latest
    container:
      image: google/dart:latest
    name: Check ${{ matrix.package }}
    env:
      PACKAGE: ${{ matrix.package }}
    steps:
      - name: Clone repository
        uses: actions/checkout@v2
      - name: Activate tools
        run: |
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
          pub global activate melos
          pub global activate uni
      - name: Check pubspec
        run: |
          melos clean
          melos --scope $PACKAGE exec -- git diff --exit-code pubspec.yaml
      - name: Bootstrap
        run: |
          melos --scope $PACKAGE bootstrap
      - name: Get dependencies
        run: |
          melos --scope $PACKAGE exec -- uni pub get
      - name: Run builders
        run: |
          melos --scope $PACKAGE pub run build_runner build --delete-conflicting-outputs
      - name: Check build diff
        run: |
          melos --scope $PACKAGE exec git diff --exit-code **/*.gql.dart
      - name: Check formatting
        run: |
          echo ""
          echo "A list of incorrectly formatted files may follow:"
          echo ""
          melos --scope $PACKAGE uni --tooling legacy format -n . --set-exit-if-changed
          echo ""
      - name: Analyze package
        run: |
          melos --scope $PACKAGE exec -- uni analyze --version
          melos --scope $PACKAGE exec -- uni analyze --fatal-warnings .
      - name: Run tests
        run: |
          melos --scope $PACKAGE exec -- [ -d ./test ] || exit 0
          melos --scope $PACKAGE exec -- uni test

  publish_dry_run:
    runs-on: ubuntu-latest
    container:
      image: google/dart:latest
    env:
      PACKAGES: 'gql,gql_build,gql_code_builder,gql_dedupe_link,gql_dio_link,gql_exec,gql_http_link,gql_link,gql_pedantic,gql_transform_link,gql_error_link,gql_websocket_link'
      PUB_ACCESS_TOKEN: ${{ secrets.PUB_ACCESS_TOKEN }}
      PUB_REFRESH_TOKEN: ${{ secrets.PUB_REFRESH_TOKEN }}
    steps:
      - name: Clone repository
        uses: actions/checkout@v2
      - name: Activate tools
        run: |
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
          pub global activate melos
          pub global activate uni
      - name: Bump to alpha version
        run: |
          melos --scope $PACKAGES pubspec bump-alpha
      - name: Sync package versions
        run: |
          melos --scope $PACKAGES pubspec sync-versions
      - name: Publish packages
        run: |
          echo "{\"accessToken\":\"$PUB_ACCESS_TOKEN\",\"refreshToken\":\"$PUB_REFRESH_TOKEN\",\"idToken\":null,\"tokenEndpoint\":\"https://accounts.google.com/o/oauth2/token\",\"scopes\":[\"openid\",\"https://www.googleapis.com/auth/userinfo.email\"],\"expiration\":1588334512218}" > $HOME/.pub-cache/credentials.json
          melos --scope $PACKAGES pub publish --dry-run
  check_svg:
    runs-on: ubuntu-latest
    container:
      image: google/dart:latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v2
      - name: Install GraphViz
        run: |
          apt update
          apt install -y graphviz
      - name: Activate tools
        run: |
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
          pub global activate melos
          pub global activate uni
      - name: Generate SVG
        run: |
          melos info | dot -Tsvg -o docs/gql.svg
          cat docs/gql.svg
      - name: Check changes
        run: |
          git diff --exit-code docs/gql.svg
